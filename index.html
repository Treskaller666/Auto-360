<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>AUTO360 — Login + App por rol (UI Pro + CRUD de Stock para Jefe)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <!-- Tipos e íconos -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
  <!-- Charts y QR -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    /* ==================== THEME (inspirado en tu logo) ==================== */
    :root{
      --bg:#060f24;         /* fondo */
      --bg2:#07122b;        /* fondo 2 */
      --panel:#0a1c42;      /* tarjeta */
      --panel2:#0a1736;     /* tarjeta secundaria */
      --stroke:#17346f;     /* bordes */
      --txt:#e9f2ff;        /* texto */
      --muted:#a9bfe9;      /* texto suave */
      --brand:#17b8ff;      /* azul eléctrico */
      --brand2:#00e0ff;     /* cian */
      --green:#2fe48d;      /* acento green (pasto) */
      --amber:#ffd166;      /* advertencia */
      --red:#ff5d72;        /* error */
      --shadow:0 20px 40px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.03);
      --glass:linear-gradient(180deg, rgba(14,34,84,.65), rgba(7,18,43,.65));
      --r1:18px; --r2:14px; --r3:12px;
      --focus:0 0 0 6px rgba(0,224,255,.22), 0 0 0 1px var(--brand2);
    }

    /* ==================== RESET ==================== */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Plus Jakarta Sans", Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--txt); letter-spacing:.2px;
      background:
        radial-gradient(1200px 600px at 110% -10%, #122e78 0%, transparent 60%),
        radial-gradient(1400px 900px at -10% 120%, #0c235a 0%, transparent 65%),
        linear-gradient(180deg,#06102a 0%, #060f24 100%);
      background-color:var(--bg);
    }
    a{color:var(--brand2); text-decoration:none}
    a:hover{text-decoration:underline}

    /* ==================== TOPBAR ==================== */
    .topbar{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; gap:14px;
      padding:14px 20px; border-bottom:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(7,18,43,.85), rgba(7,18,43,.55));
      backdrop-filter: blur(10px) saturate(1.2);
    }
    .brand{
      display:flex; gap:12px; align-items:center; font-weight:800;
      letter-spacing:.35px; font-size:1.05rem;
    }
    .brand i{color:var(--brand2); font-size:22px}
    .brand-badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 12px; border-radius:999px;
      border:1px solid #12326e; color:#bcd2ff;
      background:linear-gradient(180deg,#0a1e4a,#081739);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.03);
      font-weight:700;
    }
    .sp{flex:1}
    .btn{
      display:inline-flex; align-items:center; gap:8px; cursor:pointer;
      padding:11px 14px; border-radius:14px; font-weight:700; letter-spacing:.15px;
      border:1px solid var(--stroke); background:linear-gradient(180deg,#0c2253,#0a1a3d);
      color:var(--txt); box-shadow:var(--shadow); transition:transform .16s ease, box-shadow .16s ease;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:focus-visible{outline:none; box-shadow:var(--focus)}
    .btn--brand{
      border-color:#0b8fc0;
      background:linear-gradient(180deg,#10b8ff,#00d4ff);
      color:#071733;
    }
    .btn--ghost{background:transparent}

    /* ==================== LAYOUT ==================== */
    .wrap{max-width:1250px; margin:0 auto; padding:24px}
    .page{display:none; animation:fade .25s ease both}
    .page.active{display:block}
    @keyframes fade{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}

    .hero{
      display:grid; grid-template-columns:1fr auto; gap:12px; align-items:center;
      border:1px solid var(--stroke); border-radius:var(--r1);
      padding:22px; background:var(--glass); box-shadow:var(--shadow);
    }
    .hero h1{margin:0; font-size:1.65rem; letter-spacing:.3px}
    .logo-slot{
      width:64px; height:64px; border-radius:14px; overflow:hidden;
      border:1px solid #144; background:linear-gradient(180deg,#073,#021);
      display:grid; place-items:center;
    }
    .logo-slot img{width:100%; height:100%; object-fit:cover}

    .grid{display:grid; gap:18px; grid-template-columns:1.05fr .95fr}
    @media (max-width:1080px){.grid{grid-template-columns:1fr}}

    .card{
      border:1px solid var(--stroke); border-radius:var(--r1);
      background:linear-gradient(180deg,#0a1c42,#0a1736);
      box-shadow:var(--shadow); overflow:hidden;
    }
    .card-hd{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px 16px; border-bottom:1px solid var(--stroke);
      background:linear-gradient(180deg,rgba(15,40,96,.35),rgba(10,23,54,.2));
    }
    .card-ttl{display:flex; align-items:center; gap:10px; font-weight:800}
    .card-ttl i{color:var(--brand2)}
    .card-bd{padding:16px}

    .muted{color:var(--muted)}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px; border:1px solid var(--stroke);
      background:linear-gradient(180deg,#0b1e47,#081739); color:#bcd2ff; font-weight:700;
    }

    /* ==================== FORM ==================== */
    .row{display:grid; gap:12px; grid-template-columns:repeat(12,1fr)}
    .col-12{grid-column:span 12} .col-6{grid-column:span 6} .col-4{grid-column:span 4}
    @media (max-width:720px){.col-6,.col-4{grid-column:span 12}}
    label{font-size:.9rem; color:var(--muted); display:block; margin:6px 0}
    input,select,textarea{
      width:100%; padding:12px; border-radius:12px; border:1px solid var(--stroke);
      background:linear-gradient(180deg,#0b1b3e,#091531); color:var(--txt)
    }
    input:focus,select:focus,textarea:focus{outline:none; box-shadow:var(--focus)}

    /* ==================== TABLE ==================== */
    .table{width:100%; border-collapse:collapse; overflow:hidden}
    .table th, .table td{padding:12px 10px; border-bottom:1px solid var(--stroke); text-align:left}
    .table thead th{color:#bed4ff; font-weight:800; font-size:.92rem}
    .table tbody tr:hover{background:linear-gradient(90deg, rgba(13,48,120,.18), rgba(9,28,66,.05))}
    .actions{display:flex; gap:8px}

    /* ==================== MODAL ==================== */
    .modal{position:fixed; inset:0; display:none; place-items:center; z-index:60;
      background:rgba(3,8,22,.6); backdrop-filter: blur(10px) saturate(1.1)}
    .modal.open{display:grid}
    .modal-panel{
      width:min(780px,95vw); border:1px solid var(--stroke); border-radius:22px;
      background:linear-gradient(180deg,#0c2253,#0a193f); box-shadow:var(--shadow); overflow:hidden
    }
    .modal-hd{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:14px 16px; border-bottom:1px solid var(--stroke)}
    .modal-bd{padding:16px}

    /* ==================== TABS ==================== */
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      padding:9px 12px; border-radius:12px; border:1px solid var(--stroke);
      background:linear-gradient(180deg,#0a1f49,#09173a); color:#bcd2ff; cursor:pointer; font-weight:700
    }
    .tab.active{background:linear-gradient(180deg,#10398f,#0e2a6b); color:#fff; border-color:#1b59d8}

    .tabpanel{display:none}
    .tabpanel.active{display:block}

    /* ==================== BADGES ==================== */
    .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--stroke); border-radius:999px}
    .chip.low{color:#ffb6bf; border-color:#6b2130}
    .chip.ok{color:#9fe4c4; border-color:#1b5}

    /* ==================== FLOAT ACTION ==================== */
    .fab{
      position:fixed; right:22px; bottom:22px; z-index:40;
      display:none; align-items:center; gap:10px;
      padding:14px 16px; border-radius:16px; border:1px solid #0c7aa5;
      background:linear-gradient(180deg,#10b8ff,#00d4ff); color:#071733; font-weight:800;
      box-shadow:0 14px 30px rgba(0,210,255,.25);
    }
    .fab i{font-size:20px}
    .fab.show{display:inline-flex}

    /* ==================== SEARCH ==================== */
    .search{
      display:flex; gap:10px; align-items:center;
      padding:10px 12px; border:1px solid var(--stroke); border-radius:12px;
      background:linear-gradient(180deg,#0b1b3e,#091531); color:var(--muted); max-width:380px
    }
    .search input{all:unset; color:var(--txt); width:100%}
  </style>
</head>
<body>
  <!-- ==================== TOPBAR ==================== -->
  <div class="topbar">
    <div class="brand">
      <i class="ri-car-fill"></i><span>AUTO360</span>
      <span class="brand-badge"><i class="ri-sparkling-2-line"></i> Taller inteligente</span>
    </div>
    <div class="sp"></div>
    <button class="btn btn--ghost" id="btnGoLogin"><i class="ri-login-circle-line"></i> Iniciar sesión</button>
    <button class="btn btn--ghost" id="btnLogout" style="display:none"><i class="ri-logout-box-line"></i> Salir</button>
  </div>

  <div class="wrap">
    <!-- ==================== PAGE: LOGIN ==================== -->
    <section id="page-login" class="page active" aria-label="Inicio y acceso">
      <div class="hero">
        <div>
          <h1>AUTO360 — plataforma pro para tu taller</h1>
          <p class="muted">Agenda, diagnóstico, inventario con <b>CRUD completo</b>, ventas, dashboard en tiempo real y postventa.</p>
        </div>
        <div class="logo-slot" title="Tu logo">
          <!-- Si quieres, coloca tu imagen aquí (mismo directorio) -->
          <!-- <img src="auto360-logo.png" alt="AUTO360"/> -->
          <i class="ri-car-line" style="font-size:34px;color:#bdf"></i>
        </div>
      </div>

      <div class="grid" style="margin-top:16px">
        <div class="card">
          <div class="card-hd">
            <div class="card-ttl"><i class="ri-login-circle-line"></i> Acceso</div>
            <span class="pill">Demo local (rol por cuenta)</span>
          </div>
          <div class="card-bd">
            <div class="row">
              <div class="col-6">
                <label>Email</label>
                <input id="lg_email" placeholder="tú@dominio.cl" autocomplete="username">
              </div>
              <div class="col-6">
                <label>Contraseña</label>
                <input id="lg_pass" type="password" placeholder="••••••••" autocomplete="current-password">
              </div>
              <div class="col-12">
                <button class="btn btn--brand" id="btnLogin"><i class="ri-login-box-line"></i> Entrar</button>
              </div>
            </div>
            <div class="card" style="margin-top:14px">
              <div class="card-hd">
                <div class="card-ttl"><i class="ri-key-2-line"></i> Cuentas de prueba</div>
              </div>
              <div class="card-bd">
                <p class="muted" style="margin:0">
                  <b>recepcionista@demo.cl / 123456</b> — recepcionista<br/>
                  <b>jefe@demo.cl / 123456</b> — jefe (con CRUD de stock)<br/>
                  <b>tecnico@demo.cl / 123456</b> — técnico
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-hd">
            <div class="card-ttl"><i class="ri-information-2-line"></i> Flujo y roles</div>
          </div>
          <div class="card-bd">
            <ul style="margin:0 0 10px 18px" class="muted">
              <li><b>Recepcionista:</b> agenda, check-in QR.</li>
              <li><b>Jefe:</b> KPIs + <b>citas del día</b> + <b>ventas por recepcionista</b> + <b>CRUD de stock</b> + CxC.</li>
              <li><b>Técnico:</b> tareas y consumo de repuestos.</li>
            </ul>
            <p class="muted">El diseño usa <b>glassmorphism</b>, <b>neón sutil</b> y transiciones suaves para una experiencia premium.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ==================== PAGE: APP ==================== -->
    <section id="page-app" class="page" aria-label="Aplicación">
      <div class="card" style="margin-bottom:16px">
        <div class="card-hd">
          <div class="card-ttl"><i class="ri-user-3-line"></i> Sesión</div>
          <span class="pill"><span id="whoami">—</span></span>
        </div>
        <div class="card-bd">
          <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap">
            <span class="search"><i class="ri-search-2-line"></i><input id="globalSearch" placeholder="Buscar en tablas visibles…"></span>
            <span class="muted" style="margin-left:auto">Hora: <b id="stamp">—</b></span>
          </div>
        </div>
      </div>

      <!-- ==================== RECEPCIONISTA ==================== -->
      <div id="view-recepcionista" class="card" style="display:none">
        <div class="card-hd">
          <div class="card-ttl"><i class="ri-calendar-check-fill"></i> Agenda & Recepción</div>
          <span class="pill">Recepcionista</span>
        </div>
        <div class="card-bd">
          <div class="row">
            <div class="col-6">
              <h3 style="margin:8px 0">Nueva cita</h3>
              <div class="row">
                <div class="col-6"><label>Fecha</label><input id="ap_date" type="date"></div>
                <div class="col-6"><label>Hora</label><input id="ap_time" type="time"></div>
                <div class="col-12"><label>Servicio</label>
                  <select id="ap_service">
                    <option>Cambio de aceite</option><option>Frenos</option><option>Afinación</option><option>Neumáticos</option><option>Diagnóstico general</option>
                  </select>
                </div>
                <div class="col-6"><label>Marca</label><input id="ap_brand" placeholder="Toyota"></div>
                <div class="col-6"><label>Modelo</label><input id="ap_model" placeholder="Yaris 1.5"></div>
                <div class="col-6"><label>Patente</label><input id="ap_plate" placeholder="AA-BB-11"></div>
                <div class="col-6"><label>Dueño</label><input id="ap_owner" placeholder="Nombre y apellido"></div>
                <div class="col-12"><button class="btn btn--brand" id="btnAddAp"><i class="ri-add-circle-line"></i> Agendar</button></div>
              </div>
              <div style="height:10px"></div>
              <div class="row">
                <div class="col-6"><button class="btn" id="btnGenQRAgendar"><i class="ri-qrcode-line"></i> QR Agendar</button><div id="qrAgendar" style="margin-top:10px"></div></div>
                <div class="col-6"><button class="btn" id="btnGenQRCheckin"><i class="ri-qr-scan-2-line"></i> QR Check-in</button><div id="qrCheckin" style="margin-top:10px"></div></div>
              </div>
            </div>
            <div class="col-6">
              <h3 style="margin:8px 0">Citas</h3>
              <table class="table" id="tblApptsWrap">
                <thead><tr><th>Cliente</th><th>Vehículo</th><th>Fecha</th><th>Hora</th><th>Servicio</th><th>Estado</th><th></th></tr></thead>
                <tbody id="tblAppts"></tbody>
              </table>
              <div class="pill" style="margin-top:10px"><i class="ri-information-line"></i> Flujo: solicitada → confirmada → recepción → diagnóstico → reparación → finalizada</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== JEFE ==================== -->
      <div id="view-jefe" class="card" style="display:none; margin-top:16px">
        <div class="card-hd">
          <div class="card-ttl"><i class="ri-dashboard-2-fill"></i> Dashboard del Jefe</div>
          <span class="pill">KPIs + Citas + Ventas + Stock (CRUD) + CxC</span>
        </div>
        <div class="card-bd">
          <!-- KPIs -->
          <div class="row">
            <div class="col-4"><label>Ventas Hoy</label><div id="kpiSalesToday" class="pill">—</div></div>
            <div class="col-4"><label>Ventas Mes</label><div id="kpiSalesMonth" class="pill">—</div></div>
            <div class="col-4"><label>Ticket Promedio</label><div id="kpiAvgTicket" class="pill">—</div></div>
            <div class="col-12" style="margin-top:12px"><canvas id="salesLine" height="74"></canvas></div>
          </div>

          <!-- TABS -->
          <div class="card" style="margin-top:16px">
            <div class="card-hd"><div class="card-ttl"><i class="ri-layout-grid-line"></i> Paneles</div></div>
            <div class="card-bd">
              <div class="tabs" id="bossTabs">
                <button class="tab active" data-panel="citas">Citas del día</button>
                <button class="tab" data-panel="recep">Recepcionistas & Ventas</button>
                <button class="tab" data-panel="stock">Stock & CRUD</button>
                <button class="tab" data-panel="cxc">Cuentas por cobrar</button>
              </div>

              <!-- CITAS -->
              <div id="panel-citas" class="tabpanel active">
                <table class="table">
                  <thead><tr><th>Cliente</th><th>Patente</th><th>Servicio</th><th>Fecha</th><th>Hora</th><th>Estado</th></tr></thead>
                  <tbody id="bossAppts"></tbody>
                </table>
              </div>

              <!-- RECEPCIONISTAS -->
              <div id="panel-recep" class="tabpanel">
                <table class="table">
                  <thead><tr><th>Recepcionista</th><th>Email</th><th>Ventas hoy</th><th>Ventas mes</th><th>Último movimiento</th></tr></thead>
                  <tbody id="tblReception"></tbody>
                </table>
              </div>

              <!-- STOCK (CRUD) -->
              <div id="panel-stock" class="tabpanel">
                <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:10px">
                  <span class="search"><i class="ri-search-2-line"></i><input id="stockSearch" placeholder="Buscar repuesto…"></span>
                  <div style="display:flex; gap:8px; align-items:center">
                    <button class="btn btn--brand" id="btnAddItem"><i class="ri-add-circle-line"></i> Nuevo ítem</button>
                    <button class="btn" id="btnExportCSV"><i class="ri-download-2-line"></i> Exportar CSV</button>
                  </div>
                </div>
                <table class="table" id="tblStockBossWrap">
                  <thead><tr>
                    <th>Código</th><th>Descripción</th><th>Stock</th><th>Mínimo</th><th>Estado</th><th style="width:160px">Acciones</th>
                  </tr></thead>
                  <tbody id="bossStock"></tbody>
                </table>
                <p class="muted" style="margin-top:8px">Consejo: mantén “mínimo” exacto para activar alertas <i class="ri-alert-line"></i> justo a tiempo.</p>
              </div>

              <!-- CxC -->
              <div id="panel-cxc" class="tabpanel">
                <table class="table">
                  <thead><tr><th>Cliente</th><th>Vehículo</th><th>Total</th><th>Pagado</th><th>Saldo</th></tr></thead>
                  <tbody id="tblAR"></tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- ==================== TÉCNICO ==================== -->
      <div id="view-tecnico" class="card" style="display:none; margin-top:16px">
        <div class="card-hd">
          <div class="card-ttl"><i class="ri-hammer-fill"></i> Reparación e Inventario</div>
          <span class="pill">Técnico</span>
        </div>
        <div class="card-bd">
          <div class="row">
            <div class="col-6">
              <label>Cita en reparación</label>
              <select id="rp_appt"></select>
            </div>
            <div class="col-6">
              <label>Tarea realizada</label>
              <input id="rp_task" placeholder="Ej. Cambio pastillas delanteras">
            </div>
            <div class="col-6">
              <label>Repuesto</label>
              <select id="rp_part"></select>
            </div>
            <div class="col-4">
              <label>Cantidad</label>
              <input id="rp_qty" type="number" min="1" value="1">
            </div>
            <div class="col-2" style="display:flex; align-items:end">
              <button class="btn" id="btnUseStock"><i class="ri-checkbox-circle-line"></i> Marcar</button>
            </div>
            <div class="col-12" style="margin-top:10px">
              <h4>Stock</h4>
              <table class="table">
                <thead><tr><th>Código</th><th>Descripción</th><th>Stock</th><th>Mínimo</th></tr></thead>
                <tbody id="tblStock"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </section>
  </div>

  <!-- ==================== MODAL: CRUD STOCK ==================== -->
  <div class="modal" id="stockModal" role="dialog" aria-modal="true">
    <div class="modal-panel">
      <div class="modal-hd">
        <div class="card-ttl"><i class="ri-tools-fill"></i> <span id="stockModalTitle">Nuevo ítem</span></div>
        <div class="actions">
          <button class="btn" id="btnCloseModal"><i class="ri-close-line"></i> Cerrar</button>
        </div>
      </div>
      <div class="modal-bd">
        <div class="row">
          <div class="col-6"><label>Código</label><input id="f_code" placeholder="ACE-5W30"></div>
          <div class="col-6"><label>Descripción</label><input id="f_name" placeholder="Aceite 5W30 1L"></div>
          <div class="col-4"><label>Stock</label><input id="f_qty" type="number" min="0" value="0"></div>
          <div class="col-4"><label>Mínimo</label><input id="f_min" type="number" min="0" value="0"></div>
          <div class="col-4"><label>&nbsp;</label><button class="btn btn--brand" id="btnSaveItem"><i class="ri-save-3-line"></i> Guardar</button></div>
          <div class="col-12"><p class="muted" id="f_tip" style="margin:6px 0 0 0">Sugerencia: define <b>mínimo</b> para activar alertas de reposición.</p></div>
        </div>
      </div>
    </div>
  </div>

  <!-- FAB para “Nuevo Ítem” -->
  <button class="fab" id="fabNew"><i class="ri-add-line"></i> Nuevo ítem</button>

<script>
/* =========================================================
   SPA DEMO — LOGIN SIN SELECTOR + APP POR ROL
   CRUD de Stock completo para el rol "jefe"
   Persistencia: localStorage
   ========================================================= */
const $ = (q, el=document)=> el.querySelector(q)
const $$ = (q, el=document)=> Array.from(el.querySelectorAll(q))
const fmtCLP = (n)=> new Intl.NumberFormat('es-CL',{style:'currency',currency:'CLP',maximumFractionDigits:0}).format(n||0)

const DEMO_USERS = [
  {email:'recepcionista@demo.cl', pass:'123456', role:'recepcionista', name:'Recepcionista 1'},
  {email:'jefe@demo.cl',          pass:'123456', role:'jefe',          name:'Jefe de Taller'},
  {email:'tecnico@demo.cl',       pass:'123456', role:'tecnico',       name:'Técnico 1'},
]
const RECEPT_LIST = [
  {name:'Recepcionista 1', email:'recepcionista@demo.cl'},
  {name:'Recepcionista 2', email:'recep2@demo.cl'},
]

// Estado
const store = {
  appts: JSON.parse(localStorage.getItem('mi360_appts')||'[]'),
  stock: JSON.parse(localStorage.getItem('mi360_stock')||'[]'),
  sales: JSON.parse(localStorage.getItem('mi360_sales')||'[]'), // {id, amount, at, agentEmail}
  quotes: JSON.parse(localStorage.getItem('mi360_quotes')||'{}'),
  save(){
    localStorage.setItem('mi360_appts', JSON.stringify(this.appts))
    localStorage.setItem('mi360_stock', JSON.stringify(this.stock))
    localStorage.setItem('mi360_sales', JSON.stringify(this.sales))
    localStorage.setItem('mi360_quotes', JSON.stringify(this.quotes))
  }
};
// Semillas
if(!store.stock.length){
  store.stock = [
    {code:'ACE-5W30', name:'Aceite 5W30 1L', qty:24, min:6},
    {code:'FLT-ACE',  name:'Filtro de aceite', qty:18, min:8},
    {code:'BRK-PADF', name:'Pastillas de freno DEL', qty:8, min:4},
    {code:'NEU-195',  name:'Neumático 195/65 R15', qty:6, min:6},
  ]
}
if(!store.sales.length){
  const today = new Date().toISOString().slice(0,10)
  store.sales = [
    {id:'S1', amount:90000, at: today+'T09:12:00', agentEmail:'recepcionista@demo.cl'},
    {id:'S2', amount:120000, at: today+'T11:40:00', agentEmail:'recepcionista@demo.cl'},
    {id:'S3', amount:80000,  at: today+'T16:05:00', agentEmail:'recep2@demo.cl'}
  ]
}
store.save()

/* ---------------- Router ---------------- */
function go(hash){ location.hash = hash }
function route(){
  const h = location.hash || '#/login'
  const isAuth = !!localStorage.getItem('mi360_user')
  $('#btnLogout').style.display = isAuth ? 'inline-flex' : 'none'
  $('#btnGoLogin').style.display = isAuth ? 'none' : 'inline-flex'
  $$('.page').forEach(p=> p.classList.remove('active'))
  if(h.startsWith('#/app')){
    if(!isAuth){ return go('#/login') }
    $('#page-app').classList.add('active')
    renderAppByRole()
  }else{
    $('#page-login').classList.add('active')
  }
}
window.addEventListener('hashchange', route)
window.addEventListener('load', route)

$('#btnGoLogin').onclick = ()=> go('#/login')
$('#btnLogout').onclick = ()=>{
  localStorage.removeItem('mi360_user')
  localStorage.removeItem('mi360_role')
  alert('Sesión cerrada')
  go('#/login')
}

/* ---------------- Login ---------------- */
$('#btnLogin').onclick = ()=>{
  const email = $('#lg_email').value.trim()
  const pass  = $('#lg_pass').value
  if(!email || !pass){ alert('Completa email y contraseña'); return }
  const user = DEMO_USERS.find(u=> u.email===email && u.pass===pass)
  if(!user){ alert('Credenciales inválidas. Usa una cuenta demo o integra tu backend.'); return }
  localStorage.setItem('mi360_user', user.email)
  localStorage.setItem('mi360_role', user.role)
  go('#/app')
}

/* ---------------- App por rol ---------------- */
function renderAppByRole(){
  const role = localStorage.getItem('mi360_role')||'recepcionista'
  const user = localStorage.getItem('mi360_user')||'user@demo.cl'
  $('#whoami').textContent = `${user} — ${role.toUpperCase()}`
  $('#stamp').textContent = new Date().toLocaleString('es-CL')

  $('#view-recepcionista').style.display='none'
  $('#view-jefe').style.display='none'
  $('#view-tecnico').style.display='none'
  $('#fabNew').classList.remove('show')

  if(role==='recepcionista'){ showRecepcionista() }
  if(role==='jefe'){ showJefe() }
  if(role==='tecnico'){ showTecnico() }
}

/* ---------------- Recepcionista ---------------- */
function showRecepcionista(){
  $('#view-recepcionista').style.display='block'
  renderAppts()
  $('#btnGenQRAgendar').onclick = ()=> makeQR('qrAgendar', location.origin + '/public/agendar')
  $('#btnGenQRCheckin').onclick = ()=> makeQR('qrCheckin', location.origin + '/public/checkin')
  $('#btnAddAp').onclick = addAppt
}
function addAppt(){
  const date=$('#ap_date').value, time=$('#ap_time').value, svc=$('#ap_service').value
  const brand=$('#ap_brand').value.trim(), model=$('#ap_model').value.trim()
  const plate=$('#ap_plate').value.trim(), owner=$('#ap_owner').value.trim()
  if(!date || !time || !plate || !owner){ alert('Fecha, hora, patente y dueño son obligatorios.'); return }
  const id='AP'+Date.now()
  store.appts.push({id,date,time,svc,brand,model,plate,owner,status:'solicitada'})
  store.save(); renderAppts()
  ;['ap_date','ap_time','ap_brand','ap_model','ap_plate','ap_owner'].forEach(id=> $('#'+id).value='')
}
function renderAppts(){
  const tb = $('#tblAppts'); if(!tb) return; tb.innerHTML=''
  store.appts.sort((a,b)=> (a.date+a.time).localeCompare(b.date+b.time)).forEach(ap=>{
    const tr = document.createElement('tr')
    tr.innerHTML = `<td>${ap.owner}</td><td>${ap.brand||'-'} ${ap.model||''}</td><td>${ap.date}</td><td>${ap.time}</td><td>${ap.svc}</td><td>${ap.status}</td>
    <td><button class="btn" data-id="${ap.id}" data-action="next"><i class="ri-skip-right-line"></i></button></td>`
    tb.appendChild(tr)
  })
  tb.onclick = (e)=>{
    const b = e.target.closest('button'); if(!b) return
    const ap = store.appts.find(x=> x.id===b.dataset.id); if(!ap) return
    const flow = ['solicitada','confirmada','en recepción','en diagnóstico','en reparación','finalizada']
    const i = Math.max(0, flow.indexOf(ap.status))
    ap.status = flow[Math.min(i+1, flow.length-1)]
    store.save(); renderAppts()
  }
}
function makeQR(elId, text){
  const box = $('#'+elId); if(!box) return; box.innerHTML=''
  new QRCode(box, {text, width:160, height:160, colorDark:"#00e0ff", colorLight:"#060f24", correctLevel:QRCode.CorrectLevel.H})
}

/* ---------------- Jefe ---------------- */
let chartLine;
function showJefe(){
  $('#view-jefe').style.display='block'
  $('#fabNew').classList.add('show')   // FAB para crear ítem rápido
  $('#fabNew').onclick = ()=> openStockModal()

  // Tabs
  const tabs = $('#bossTabs')
  tabs.onclick = (e)=>{
    const t = e.target.closest('.tab'); if(!t) return
    $$('.tab', tabs).forEach(b=> b.classList.remove('active'))
    t.classList.add('active')
    const tgt = t.dataset.panel
    $$('.tabpanel').forEach(p=> p.classList.remove('active'))
    $('#panel-'+tgt).classList.add('active')
  }

  // KPI + gráficos
  recalcKPIsAndCharts()

  // paneles
  renderBossAppts()
  renderBossReception()
  renderBossStock()
  renderAR()

  // Buscar global
  $('#globalSearch').oninput = ()=>{
    const q = $('#globalSearch').value.toLowerCase()
    ;[['bossAppts'],['tblReception'],['bossStock'],['tblAR']].forEach(([id])=>{
      $$('#'+id+' tr').forEach(tr=>{
        const txt = tr.innerText.toLowerCase()
        tr.style.display = txt.includes(q) ? '' : 'none'
      })
    })
  }
}
function recalcKPIsAndCharts(){
  const today = new Date().toISOString().slice(0,10)
  const ym = today.slice(0,7)
  const totToday = store.sales.filter(s=> (s.at||'').slice(0,10)===today).reduce((a,b)=>a+b.amount,0)
  const totMonth = store.sales.filter(s=> (s.at||'').slice(0,7)===ym).reduce((a,b)=>a+b.amount,0)
  const finished = store.appts.filter(a=> a.status==='finalizada')
  const avg = finished.length ? Math.round(finished.reduce(sum=> sum + (Math.random()*50000+80000),0)/finished.length) : 0
  $('#kpiSalesToday').textContent = fmtCLP(totToday)
  $('#kpiSalesMonth').textContent = fmtCLP(totMonth)
  $('#kpiAvgTicket').textContent = fmtCLP(avg)

  const byDate={}
  store.sales.forEach(s=>{ const d=(s.at||today).slice(0,10); byDate[d]=(byDate[d]||0)+s.amount })
  const days = Object.keys(byDate).sort().slice(-10)
  const ctx = document.getElementById('salesLine')
  chartLine && chartLine.destroy()
  chartLine = new Chart(ctx, { type:'line',
    data:{labels:days, datasets:[{label:'Ventas', data:days.map(d=>byDate[d]), tension:.35}]},
    options:{plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
  })
}
function renderBossAppts(){
  const tb = $('#bossAppts'); tb.innerHTML=''
  const today = new Date().toISOString().slice(0,10)
  store.appts.filter(a=> a.date===today).sort((a,b)=> a.time.localeCompare(b.time)).forEach(a=>{
    const tr = document.createElement('tr')
    tr.innerHTML = `<td>${a.owner}</td><td>${a.plate||'-'}</td><td>${a.svc}</td><td>${a.date}</td><td>${a.time}</td><td>${a.status}</td>`
    tb.appendChild(tr)
  })
}
function renderBossReception(){
  const tb = $('#tblReception'); tb.innerHTML=''
  const today = new Date().toISOString().slice(0,10)
  const ym = today.slice(0,7)
  const totalBy = (email, range)=> store.sales
        .filter(s=> s.agentEmail===email && (range==='day' ? s.at.slice(0,10)===today : s.at.slice(0,7)===ym))
        .reduce((a,b)=>a+b.amount,0)
  RECEPT_LIST.forEach(r=>{
    const day = totalBy(r.email,'day'), mon = totalBy(r.email,'mon')
    const last = store.sales.filter(s=> s.agentEmail===r.email).sort((a,b)=> (b.at||'').localeCompare(a.at||'')).at(0)
    const tr = document.createElement('tr')
    tr.innerHTML = `<td>${r.name}</td><td>${r.email}</td><td>${fmtCLP(day)}</td><td>${fmtCLP(mon)}</td><td>${last?new Date(last.at).toLocaleString('es-CL'):'—'}</td>`
    tb.appendChild(tr)
  })
}

/* ----- STOCK CRUD (Jefe) ----- */
let editId = null
$('#btnAddItem').onclick = ()=> openStockModal()
$('#btnExportCSV').onclick = exportCSV
$('#stockSearch').oninput = ()=>{
  const q = $('#stockSearch').value.toLowerCase()
  $$('#bossStock tr').forEach(tr=>{
    tr.style.display = tr.innerText.toLowerCase().includes(q) ? '' : 'none'
  })
}

function renderBossStock(){
  const tb = $('#bossStock'); tb.innerHTML=''
  store.stock.forEach((p, idx)=>{
    const low = p.qty<=p.min
    const tr = document.createElement('tr')
    tr.innerHTML = `
      <td>${p.code}</td>
      <td>${p.name}</td>
      <td>${p.qty}</td>
      <td>${p.min}</td>
      <td>${low?'<span class="chip low"><i class="ri-alert-line"></i> Bajo</span>':'<span class="chip ok"><i class="ri-checkbox-circle-line"></i> OK</span>'}</td>
      <td class="actions">
        <button class="btn" data-i="${idx}" data-act="edit"><i class="ri-pencil-line"></i></button>
        <button class="btn" data-i="${idx}" data-act="clone"><i class="ri-file-copy-line"></i></button>
        <button class="btn" data-i="${idx}" data-act="del"><i class="ri-delete-bin-6-line"></i></button>
      </td>`
    tb.appendChild(tr)
  })
  // acciones
  tb.onclick = (e)=>{
    const btn = e.target.closest('button'); if(!btn) return
    const i = Number(btn.dataset.i)
    const act = btn.dataset.act
    if(act==='edit') openStockModal(store.stock[i], i)
    if(act==='clone'){ const it = {...store.stock[i], code: store.stock[i].code+'-C'}; store.stock.splice(i+1,0,it); store.save(); renderBossStock() }
    if(act==='del'){
      if(confirm('¿Eliminar este ítem de stock?')){ store.stock.splice(i,1); store.save(); renderBossStock(); renderStock() }
    }
  }
}
function openStockModal(item=null, index=null){
  editId = index
  $('#stockModalTitle').textContent = item? 'Editar ítem' : 'Nuevo ítem'
  $('#f_code').value = item?.code || ''
  $('#f_name').value = item?.name || ''
  $('#f_qty').value  = item?.qty ?? 0
  $('#f_min').value  = item?.min ?? 0
  $('#stockModal').classList.add('open')
}
$('#btnCloseModal').onclick = ()=> $('#stockModal').classList.remove('open')
$('#btnSaveItem').onclick = ()=>{
  const code = $('#f_code').value.trim()
  const name = $('#f_name').value.trim()
  const qty  = Math.max(0, Number($('#f_qty').value||0))
  const min  = Math.max(0, Number($('#f_min').value||0))
  if(!code || !name){ alert('Código y descripción son obligatorios.'); return }
  const obj = {code,name,qty,min}
  if(editId==null){ store.stock.push(obj) } else { store.stock[editId] = obj }
  store.save(); $('#stockModal').classList.remove('open'); renderBossStock(); renderStock()
}
function exportCSV(){
  const rows = [['code','name','qty','min'], ...store.stock.map(s=> [s.code, s.name, s.qty, s.min])]
  const csv = rows.map(r=> r.map(x=> `"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n')
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'})
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a'); a.href=url; a.download='stock_auto360.csv'; a.click()
  URL.revokeObjectURL(url)
}

/* ---------------- Técnico ---------------- */
function showTecnico(){
  $('#view-tecnico').style.display='block'
  const rpAppt = $('#rp_appt'); rpAppt.innerHTML=''
  store.appts.filter(a=> a.status==='en reparación' || a.status==='en diagnóstico').forEach(a=>{
    const o=document.createElement('option'); o.value=a.id; o.textContent=`${a.date} ${a.time} — ${a.owner} (${a.plate||''}) [${a.status}]`; rpAppt.appendChild(o)
  })
  const rpPart = $('#rp_part'); rpPart.innerHTML=''
  store.stock.forEach(p=>{ const o=document.createElement('option'); o.value=p.code; o.textContent=`${p.code} — ${p.name} (stock: ${p.qty})`; rpPart.appendChild(o) })
  renderStock()
  $('#btnUseStock').onclick = ()=>{
    const id = $('#rp_appt').value; const code = $('#rp_part').value; const qty = Math.max(1, Number($('#rp_qty').value||1))
    const it = store.stock.find(x=> x.code===code); if(!id || !it) return alert('Selecciona cita y repuesto')
    if(it.qty<qty){ alert('Stock insuficiente'); return }
    it.qty -= qty; store.save(); renderStock(); renderBossStock(); alert('Marcado y descontado')
  }
}
function renderStock(){
  const tb = $('#tblStock'); if(!tb) return; tb.innerHTML=''
  store.stock.forEach(p=>{
    const tr = document.createElement('tr'); tr.innerHTML = `<td>${p.code}</td><td>${p.name}</td><td>${p.qty}</td><td>${p.min}</td>`
    tb.appendChild(tr)
  })
}

/* ---------------- CxC (demo) ---------------- */
function renderAR(){
  const tb = $('#tblAR'); if(!tb) return; tb.innerHTML=''
  store.appts.forEach(ap=>{
    const total = Math.round((Math.random()*50000)+90000)
    const paid = store.sales.reduce((a,b)=> a + (Math.random()<0.2?b.amount*0.2:0), 0)
    const saldo = Math.max(0, total - paid)
    const tr = document.createElement('tr')
    tr.innerHTML = `<td>${ap.owner}</td><td>${ap.brand||'-'} ${ap.model||''}</td><td>${fmtCLP(total)}</td><td>${fmtCLP(paid)}</td><td>${fmtCLP(saldo)}</td>`
    tb.appendChild(tr)
  })
}

/* ---------------- Reloj ---------------- */
setInterval(()=>{ const el=$('#stamp'); if(el) el.textContent = new Date().toLocaleString('es-CL') }, 1000)
</script>
</body>
<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// 1) Conexión
const SUPABASE_URL = "https://TU-PROYECTO.supabase.co";
const SUPABASE_ANON_KEY = "TU-ANON-KEY";
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// 2) Adaptadores UI <-> DB
const toUI = (row)=> ({ code: row.sku, name: row.nombre, qty: row.stock ?? 0, min: row.stock_min ?? 0 });
const toDB = (it)=> ({ sku: it.code, nombre: it.name, stock: it.qty ?? 0, stock_min: it.min ?? 0 });
const $ = (s)=> document.querySelector(s);

// 3) API contra 'inventario'
async function invList(){
  const { data, error } = await sb.from('inventario').select('sku,nombre,stock,stock_min').order('nombre');
  if(error) throw error;
  return data.map(toUI);
}
async function invUpsert(item){
  const row = toDB(item);
  const { data: exists } = await sb.from('inventario').select('sku').eq('sku', row.sku).maybeSingle();
  let res;
  if(exists){
    res = await sb.from('inventario').update(row).eq('sku', row.sku).select().single();
  }else{
    res = await sb.from('inventario').insert(row).select().single();
  }
  if(res.error) throw res.error;
  return toUI(res.data);
}
async function invDelete(sku){
  const { error } = await sb.from('inventario').delete().eq('sku', sku);
  if(error) throw error;
}

// 4) Wire: usa tu DOM existente (IDs ya en tu HTML)
const tbBoss = $('#bossStock');          // <tbody> jefe
const tbTech = $('#tblStock');           // <tbody> técnico (solo lectura)
const modal  = $('#stockModal');         // modal existente
const title  = $('#stockModalTitle');
const f_code = $('#f_code');
const f_name = $('#f_name');
const f_qty  = $('#f_qty');
const f_min  = $('#f_min');
const btnAdd = $('#btnAddItem');
const btnSave= $('#btnSaveItem');
const btnClose=$('#btnCloseModal');
const btnCsv = $('#btnExportCSV');

let cache = [];

function renderBoss(){
  if(!tbBoss) return;
  tbBoss.innerHTML = '';
  cache.forEach((p, idx)=>{
    const low = (p.qty||0) <= (p.min||0);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.code}</td>
      <td>${p.name}</td>
      <td>${p.qty ?? 0}</td>
      <td>${p.min ?? 0}</td>
      <td>${low?'<span class="chip low">Bajo</span>':'<span class="chip ok">OK</span>'}</td>
      <td class="actions">
        <button class="btn" data-i="${idx}" data-act="edit"><i class="ri-pencil-line"></i></button>
        <button class="btn" data-i="${idx}" data-act="clone"><i class="ri-file-copy-line"></i></button>
        <button class="btn" data-i="${idx}" data-act="del"><i class="ri-delete-bin-6-line"></i></button>
      </td>`;
    tbBoss.appendChild(tr);
  });

  tbBoss.onclick = async (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    const i = Number(b.dataset.i);
    const act = b.dataset.act;
    const it = cache[i]; if(!it) return;
    if(act==='edit'){ openModal(it); }
    if(act==='clone'){ await invUpsert({...it, code: it.code+'-C'}); await reload(); }
    if(act==='del' && confirm('¿Eliminar este ítem?')){ await invDelete(it.code); await reload(); }
  };
}

function renderTech(){
  if(!tbTech) return;
  tbTech.innerHTML = '';
  cache.forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.code}</td><td>${p.name}</td><td>${p.qty ?? 0}</td><td>${p.min ?? 0}</td>`;
    tbTech.appendChild(tr);
  });
}

function openModal(item=null){
  if(!modal) return;
  if(title) title.textContent = item ? 'Editar ítem' : 'Nuevo ítem';
  if(f_code) f_code.value = item?.code || '';
  if(f_name) f_name.value = item?.name || '';
  if(f_qty)  f_qty.value  = item?.qty  ?? 0;
  if(f_min)  f_min.value  = item?.min  ?? 0;
  modal.classList.add('open'); // respeta tu CSS
}
function closeModal(){ modal?.classList.remove('open'); }

btnAdd?.addEventListener('click', ()=> openModal());
btnClose?.addEventListener('click', closeModal);
btnSave?.addEventListener('click', async ()=>{
  const code = f_code?.value.trim();
  const name = f_name?.value.trim();
  const qty  = Math.max(0, Number(f_qty?.value||0));
  const min  = Math.max(0, Number(f_min?.value||0));
  if(!code || !name){ alert('Código y nombre son obligatorios.'); return; }
  await invUpsert({ code, name, qty, min });
  closeModal(); await reload();
});
btnCsv?.addEventListener('click', ()=>{
  const rows = [['code','name','qty','min'], ...cache.map(s=> [s.code, s.name, s.qty||0, s.min||0])];
  const csv = rows.map(r=> r.map(x=> `"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='stock_supabase.csv'; a.click(); URL.revokeObjectURL(url);
});

async function reload(){
  cache = await invList();
  renderBoss(); renderTech();
}

// Primera carga
reload();
</script>
<script type="module">
// Reusa 'sb' del bloque anterior (mismo archivo)

async function upsertCliente({ nombre, rut=null, email=null, telefono=null }){
  if(email){
    const { data } = await sb.from('cliente').select('*').eq('email', email).maybeSingle();
    if(data) return data;
  }
  if(rut){
    const { data } = await sb.from('cliente').select('*').eq('rut', rut).maybeSingle();
    if(data) return data;
  }
  const { data, error } = await sb.from('cliente').insert({ nombre, rut, email, telefono }).select().single();
  if(error) throw error; return data;
}
async function upsertVehiculo({ cliente_id, patente, marca=null, modelo=null, ano=null }){
  const { data: v } = await sb.from('vehiculo').select('*').eq('patente', patente).maybeSingle();
  if(v) return v;
  const { data, error } = await sb.from('vehiculo').insert({ cliente_id, patente, marca, modelo, ano }).select().single();
  if(error) throw error; return data;
}
export async function crearCitaUI({ fecha, hora, servicio, marca, modelo, patente, dueno }){
  // crea cliente + vehiculo si no existen
  const cli = await upsertCliente({ nombre: dueno, email: null, telefono: null });
  const veh = await upsertVehiculo({ cliente_id: cli.id, patente, marca, modelo, ano: null });

  const fecha_inicio = new Date(`${fecha}T${hora}:00Z`).toISOString();
  const { data, error } = await sb.from('cita').insert({
    cliente_id: cli.id, vehiculo_id: veh.id, fecha_inicio, fecha_fin: fecha_inicio, motivo: servicio, estado: 'PENDIENTE'
  }).select().single();
  if(error) throw error; return data;
}

export async function listarCitasUI(){
  const { data, error } = await sb
    .from('cita')
    .select('id, fecha_inicio, estado, motivo, cliente(nombre), vehiculo(patente)')
    .order('fecha_inicio');
  if(error) throw error; return data;
}
</script>


